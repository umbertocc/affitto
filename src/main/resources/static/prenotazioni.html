<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèñÔ∏è Torre Pali Salento - Calendario Disponibilit√† Affitto</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --fc-border-color: #e0e7ff;
      --fc-daygrid-event-dot-width: 8px;
      --fc-page-bg-color: #f8fafc;
      --fc-neutral-bg-color: #f1f5f9;
      --fc-today-bg-color: #dbeafe;
      --fc-button-bg: linear-gradient(135deg, #007BFF, #0056b3);
      --fc-button-border-color: #007BFF;
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); margin: 0; padding: 20px; }
    h1 { text-align: center; color: #1e293b; margin-bottom: 30px; }
    
    /* BACK BUTTON - IDENTICO A TORRE-PALI.HTML */
    .btn {
      background: #27ae60;
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.2em;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 5px 15px rgba(39,174,96,0.3);
      transition: all 0.3s;
      margin: 30px 0;
      text-align: center;
    }
    .btn:hover {
      background: #219a52;
      transform: translateY(-2px);
      color: white;
      text-decoration: none;
    }
    
    .fc {
      font-family: 'Segoe UI', sans-serif;
      box-shadow: 0 10px 30px rgba(0,123,255,0.2);
      border-radius: 15px;
      overflow: hidden;
      max-width: 1200px;
      margin: 0 auto;
      height: 500px;
    }
    .fc-theme-standard td, .fc-theme-standard th { border-color: var(--fc-border-color); padding: 8px; }
    .fc-daygrid-day.fc-day { background-color: #d4edda !important; border: 1px solid #c3e6cb;}
    .fc-daygrid-day.fc-day-today { background-color: #28a745 !important; }
    .fc-event { border-radius: 10px; font-size: 0.85em; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none; }
    .fc-event.fc-daygrid-event { background: #28A745 !important; }
    .fc-event.fc-daygrid-block-event { background: #dc3545 !important; }
    .fc-event-end { border-right-width: 3px !important; }
    .fc-button { border-radius: 25px; text-transform: none; font-weight: 500; }
    .fc-button-primary { background: var(--fc-button-bg); }
    .fc-button:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(0,123,255,0.4); }
    
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 900;
    }

    #bookingForm {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 480px;
      width: 92%;
      max-height: 90vh;
      height: auto;
      background: #ffffff;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      z-index: 901;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #bookingForm h3 { color: #1e293b; margin-bottom: 25px; text-align: center; font-size: 1.5em; background: linear-gradient(135deg, #007BFF, #28A745); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    #bookingForm label { display: block; margin-bottom: 15px; color: #475569; font-weight: 500; }
    #bookingForm input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box; }
    #bookingForm input:focus { outline: none; border-color: #007BFF; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); transform: translateY(-1px); }
    #bookingForm button { width: 48%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin: 6px 1%; }
    .btn-prenota { background: linear-gradient(135deg, #28A745, #20ad3f); color: white; }
    .btn-prenota:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(40,167,69,0.4); }
    .btn-chiudi { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }
    .btn-chiudi:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(107,114,128,0.4); }
    
    /* FOOTER IDENTICO A TORRE-PALI.HTML */
    footer { 
      background: #34495e; 
      color: white; 
      padding: 20px; 
      margin-top: 50px; 
      text-align: center;
    }
    
    @media (max-width: 768px) { 
      .fc { height: 400px; margin: 10px; } 
      #bookingForm { padding: 20px; margin: 20px; width: 95%; } 
      .btn { padding: 12px 24px; font-size: 1.1em; }
    }
  </style>
</head>
<body>
  <!-- BACK BUTTON -->
  <div style="text-align: center; margin-bottom: 20px;">
    <a href="index.html" class="btn">üè† Torna a Casa Bellavista 2</a>
  </div>
  
  <h1>üåä Torre Pali Salento - Verifica Disponibilit√†</h1>
  <div id='calendar'></div>
  
  <!-- FOOTER IDENTICO A TORRE-PALI.HTML -->
  <footer>
    <p>&copy; 2026 TorrePaliVacanze.it | Vacanze autentiche nel Salento</p>
  </footer>

  <div id="overlay" onclick="closeForm()" style="display: none;"></div>
  <div id="bookingForm" style="display: none;">
    <h3>üèñÔ∏è Verifica date</h3>
    <label>Check-in: <input type="date" id="checkin" required></label>
    <label>Check-out: <input type="date" id="checkout" required></label>
    <button class="btn-prenota" onclick="submitBooking()">Verifica disponibilit√†</button>
    <button class="btn-chiudi" onclick="closeForm()">Annulla</button>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8082' : 'https://affitto.torrepalivacanze.it';
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
        initialView: 'dayGridMonth',
        initialDate: new Date(),
        events: `${API_BASE_URL}/api/bookings/disponibilita-all?propertyId=1`,
        dateClick: function(info) {
          if (!info.event) {
            document.getElementById('checkin').value = info.dateStr;
            const checkout = new Date(info.date.getTime() + 5 * 24 * 60 * 60 * 1000);
            document.getElementById('checkout').value = checkout.toISOString().split('T')[0];
            document.body.style.overflow = 'hidden';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('bookingForm').style.display = 'block';
          }
        }
      });
      calendar.render();
    });

    let messaggioDiv = null;

    async function submitBooking() {
      if (messaggioDiv) messaggioDiv.remove();
      
      const checkin = document.getElementById('checkin').value;
      const checkout = document.getElementById('checkout').value;
      
      if (!checkin || !checkout) {
        Swal.fire({
          icon: 'warning',
          title: '‚ö†Ô∏è Date Incomplete',
          text: 'Inserisci check-in e check-out',
          confirmButtonText: 'OK',
          confirmButtonColor: '#ffc107'
        });
        return;
      }
      
      try {

        const response = await fetch(`${API_BASE_URL}/api/bookings/disponibilita?propertyId=1&start=${checkin}&end=${checkout}`);
        const events = await response.json();
        
        const formEsistente = document.getElementById('form-contatti');
        if (formEsistente) formEsistente.remove();
        
        messaggioDiv = document.createElement('p');
        messaggioDiv.id = 'risultato';
        messaggioDiv.style.fontWeight = 'bold';
        messaggioDiv.style.marginTop = '10px';
        
        if (events.length === 0) {
          messaggioDiv.textContent = '‚úÖ Disponibile!';
          messaggioDiv.style.color = 'green';
          
          const formContatti = document.createElement('div');
          formContatti.id = 'form-contatti';
          formContatti.style.marginTop = '15px';
          formContatti.innerHTML = `
            <h4>üìß Richiedi info al proprietario</h4>
            <input type="text" id="nomeContatto" placeholder="Nome Completo*" style="width:100%; margin:5px 0; padding:8px; required">
            <input type="email" id="emailContatto" placeholder="Email *" style="width:100%; margin:5px 0; padding:8px; required">
            <textarea id="messaggio" placeholder="Date ${checkin}‚Üí${checkout}, numero ospiti, domande...*" style="width:100%; height:80px; margin:5px 0; padding:8px; required"></textarea>
            <button onclick="inviaRichiesta()" style="background:#28a745; color:white; padding:10px; border:none; border-radius:5px; width:100%; margin:5px 0;">Invia Richiesta</button>
            <button onclick="annullaRichiesta()" style="background:#6c757d; color:white; padding:10px; border:none; border-radius:5px; width:100%; margin:5px 0;">Annulla</button>
          `;
          document.getElementById('bookingForm').appendChild(formContatti);
        } else {
          messaggioDiv.textContent = '‚ùå Non disponibile';
          messaggioDiv.style.color = 'red';
        }
        
        document.getElementById('bookingForm').appendChild(messaggioDiv);
        
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: '‚ùå Errore Connessione',
          text: 'Verifica backend attivo',
          confirmButtonColor: '#dc3545'
        });
      }
    }

    function closeForm() {
      document.getElementById('bookingForm').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
      if (messaggioDiv) messaggioDiv.remove();
      const formC = document.getElementById('form-contatti');
      if (formC) formC.remove();
      messaggioDiv = null;
      document.body.style.overflow = 'auto';
    }

    async function inviaRichiesta() {
      const nome = document.getElementById('nomeContatto').value.trim();
      const email = document.getElementById('emailContatto').value.trim();
      const messaggio = document.getElementById('messaggio').value.trim();
      
      if (!nome || !email || !messaggio) {
        Swal.fire({
          icon: 'warning',
          title: 'Campi Obbligatori',
          text: 'Nome, Messaggio ed Email richiesti',
          confirmButtonColor: '#ffc107'
        });
        return;
      }
      
      const dati = { 
        propertyId: 1,
        checkin: document.getElementById('checkin').value,
        checkout: document.getElementById('checkout').value,
        nome: document.getElementById('nomeContatto').value,
        email: document.getElementById('emailContatto').value,
        messaggio: document.getElementById('messaggio').value
      };
      
      await fetch(`${API_BASE_URL}/api/bookings/richieste`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dati)
      });
      
      Swal.fire({
        icon: 'success',
        title: 'Richiesta Inviata!',
        text: 'Il proprietario ti contatter√† presto',
        confirmButtonText: 'OK',
        confirmButtonColor: '#28a745',
        timer: 3000
      }).then(() => {
        closeForm();
      });
    }
    
    function annullaRichiesta() {
      const formC = document.getElementById('form-contatti');
      if (formC) formC.remove();
      if (messaggioDiv) messaggioDiv.remove();
      messaggioDiv = null;
    }
  </script>
</body>
</html>
